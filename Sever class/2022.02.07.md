# 2022/02/07 수업내용(복습완료)
## 네트워크
### TCP/IP
1. 일반 데이터 송신 시 PSH, ACK를 Set 하는 이유
    1) ACK: 상대방에 프레임을 보낼때마다 항상 실어서 보낸다. (언제든 신속히 데이터를 송수신하기 위함이라고 생각됨)
    2) PSH(flush): 소켓 수신 버퍼가 비어있을 때 recv 함수를 호출하면 스레드가 block 된다. 이 block 상태를 풀게하는 것이 이 PSH 컨트롤 비트이다.
        * send(14600)로 호출하여 10개의 패킷이 보내질 때 마지막 패킷에만 PSH가 1로 세워져 송신된다. 이는 L7에서 요청한 크기(14600)에 의해 정해진다.
        * 어떻게 보면 송신측에서 "다 전달됐다!"라는 표시를 해줘야 수신측에서 전달받는 동작을 완료하는 것과 같다.
2. Windows는 수신 확인 응답을 윈도우 제어 방식을 사용한다.
3. TCP 스트림: 패킷 데이터가 쪼개지는 경우
    1) 수신측의 윈도우 사이즈가 여유롭지 않은 경우
    2) 송신측에서 MSS가 여유롭지 않은 경우
4. TCP 계층(L4)에서 MSS 만큼 데이터를 조각내기 때문에 L7, IP 계층(L3)에서 조각을 낼 필요가 없다. => 재전송 시 L7계층에서만 관여하면 된다!
    * UDP의 경우에는 L7에서 데이터를 조각내서 보내야 한다.

### Reliable UDP
1. TCP 프로토콜을 바탕으로 설계, 동작 방식, 구현 방법 등 제작하는 방법을 강구해놔야 한다.
    * 헤더 구성 및 크기, ACK 타이밍, 어떻게 TCP와 같이 신뢰성을 갖게 구현할 것인지 강구 

### 공유기
1. 작동 방식(내부->외부, 동적)
    1) 사설 PC -> NAT 장비: Src IP(192.168.0.xx)와 포트번호(20000)가 송신한 PC로 설정된 패킷이 NAT 장비에 전달된다.
    2) NAT 장비 -> 게이트웨이: 전달받은 패킷의 Src IP와 포트 번호를 NAT 장비의 IP와 게이트웨이로 연결되 포트번호로 바꾼다.
    3) 이 때 포트 포워딩 테이블을 만듦
    4) 이후 게이트웨이에서 데이터가 수신되면 포트 포워딩 테이블을 들여다보고 매칭되는 사설 IP&포트번호로 헤더를 변경하여 해당 포트로 송신한다.
    * <img width=630 src="https://user-images.githubusercontent.com/95362065/152922805-93ece6ff-052d-49da-9385-7ece180c7987.png">
    * 나중에 학원에서 서버 프로그램을 켜고 집에서 테스트 프로그램을 키면 공유기가 뻗어버린다.
2. 작동 방식(외부->내부, 고정)
    * 브라우저에서 공유기의 NAT/라우터 관리 -> 포트포워드 설정을 변경하여 외부에서 내부로 연결할 수 있게 한다.
    * 그래서 P2P에서는 홀펀칭, 클라-서버 형태로 게임이 서비스 된다.
3. 포트 포워딩 테이블 최대 개수
    * 128K(64K씩 TCP + UDP)
4. 방화벽은 터널링, NAT 방식으로 나뉘어진다. 일반적으로 방화벽은 NAT 방식이다.

### 홀펀칭
1. 랑데뷰 서버를 이용한 홀펀칭
    1) 서버 역할을 할 PC가 랑데뷰 서버에 연결을 요청하여 공유기에 포트 포워딩 테이블을 만든다.
    2) 랑데뷰 서버가 다른 유저(클라)PC에게 서버 PC 포트 포워딩 정보를 건네준다. 유저 PC는 이 정보를 바탕으로 서버 PC에 연결한다.
2. TCP 방식으로 홀펀칭 시에 서버PC가 랑데뷰 서버와 1:1 통신을 하고 있기 때문에, 클라 PC가 연결하여도 의미가 없다. 따라서 주로 UDP로 홀펀칭을 함
    * 공유기는 세션 정보를 잘 알고 있어 홀펀칭 성공 확률이 적다. 프라우드넷이 홀펀칭으로 유명함.

### 릴레이 서버
1. 릴레이 서버
    1) 릴레이 서버가 중간에서 각각 서버 PC와 유저 PC와 연결을 한다.
    2) 릴레이 서버는 서버 PC로부터 받는 데이터를 유저 PC로, 유저 PC로부터 받은 데이터를 서버 PC로 중계한다.

### 네이글 알고리즘
1. 네이글 알고리즘: TCP로 송신할 데이터를 내부에서 버퍼링해서 쌓아두는 것. 기본적으로 항상 기능함
2. 네이글 OFF 방법: setsockopt 함수에서 TCP_NODELAY 옵션을 지정하면 된다.
3. 네이글의 여부는 송수신측이 서로 달라도 된다. 실제 서버에서는 네이글 ON하는 것이 비용면에서 좋다.
    * 따라서 서버에서는 네이글 on, 클라에서는 off 방식을 선호한다.
4. 네이글의 게임에서의 영향력
    1) 장르에 따라 영향력은 다 다르다. 마우스 조작 게임인 경우 네이글을 켜도 부자연스럽지 않지만 키보드 조작의 경우는 부자연스럽다.
        * 마우스 조작: 마우스 조작 자체가 느리고 클라에서 해당 조작에 대한 이펙트, 캐릭터의 움직임 정도로도 유저가 느끼기에 자연스럽기 때문이다.
5. 짧은 주기로 데이터 송수신이 일어나는 환경에서는 네이글의 효과를 많이 받지 못한다. -> 송신측에서 ACK를 1로 세워(+ACK 비트 on) 보내기 때문이다. (이전 시간에 했던 송신 동작의 조건 두 가지를 잘 생각해보자)

## 기타 키워드
### 클라우드
1. Azure-하이퍼 V: x64 시스템을 위한 하이퍼바이저 기반의 가상화 시스템
2. 클라우드 서비스 사용 시 고정 IP를 사용하고자 한다면 렌탈 개념으로 비용을 지불해야 한다.
3. 베어메탈, KT 클라우드 서비스에서는 가상 서버를 많이 사용하는 유저에게 고정된 물리 서버로 전환하라는 호객 행위를 한다.

### 서버 공격
1. SYN Flooding와 같은 공격을 대비하기 위해서는 그에 맞게 미리 서버를 설계해야 한다.
2. DrDos: 무작위 IP(수신처)에게 공격 대상의 IP가 송신처인 것 처럼 위장하여 SYN 패킷을 전송함

### 강사님 퀴즈
1. TCP 스트림이 뭉쳐지거나 조각이 나는 이유가 IP 패킷의 조각 나누기 기능 때문이다?
    * 정답: X, 애초에 TCP 계층에서 MSS 만큼 쪼개거나 뭉쳐져 보내는 것이다
