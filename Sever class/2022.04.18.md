# 2022/04/18 수업내용
## 테스트 프로그램
### 스트레스 테스트
1. 정해진 접속 및 메시지(과도한 부하를 쏟아부어)를 보내서 처리속도 및 버그(반응)를 확인하는 프로그램

### 더미(봇) 테스트
1. 목적: 스트레스 테스트보다 더 나아가 컨텐츠를 포함하여 테스트하는 프로그램
    * 실제 플레이어와 동일하게 AI를 테스트
    * 유저 DB, 로그인 등의 서버와 연동 또한 포함하여 테스트
    * 일반적으로 150% 부하 정도를 테스트
2. MMORPG는 이러한 조건으로 더미를 만드는 것은 컨텐츠가 너무 방대하다.
    1) 예를 들어 거래 시스템의 경우 모든 경우의 수에 대하여 테스트하기가 불가능하다.
3. 보통 한 프로세스에서 1천명 분의 플레이어 더미를 담당해야 한다.
4. 네트워크 트래픽
    1) 네트워크 인프라, 서버 하드웨어, 회선 비용등을 통계를 내어 퍼블리셔에게 제공해야 한다. 보통 퍼블리셔는 서버 장애 탓을 개발사에게 돌리고 싶어 한다.
        * 제대로 하려면 RAM, 메인 보드 등 까지 결정해야 한다. 하지만 보통 벤더 완성품을 구매하여 사용한다. 조립은 쓰지 않는다. (보통 스펙에 대한 얘기를 할 때 메모리, 클럭, 코어 개수 등의 언급)
    2) TPS: 시간당 플레이어 처리량. 보통 테스트 시 처리 xTPS와 테스트 툴을 퍼블리셔에 제공하여 테스트 요청을 한다.
    3) 측정 방법
        * L7 전송 크기: 실제 send를 하여 반환된 바이트 수 합계
        * IP, TCP 헤더 크기 측정: 실제 send 요청 횟수를 합산하여 * 40bytes (send 요청 크기가 MSS를 초과한 경우에 그에 상응하게 추가하여 계산)
        * 예시: 듀랑고-모닥불(클베 때 이 컨텐츠를 빼버림)
5. 모니터링 정보
    1) 매치메이킹, 경매장, 배틀 등의 영역을 나누어 끊긴 유저 수, 접속한 유저 수, 대기 유저, 플레이 유저 수 등의 모니터링 정보가 있어야 한다.
6. 패킷 송신 -> 수신의 레이턴시(평균, 최대, 최소, ...)

### 기타
1. 테스트 프로그램은 오류가 0이어야 한다. 그래서 강사님은 보통 싱글스레드로 제작한다.
2. NC에서는 리니지 이터널 제작 시에 클라 오토를 만들어 QA 시간을 단축시켰다.
3. 리플레이 기능 구현
    1) 프레임을 기준으로 메시지를 처리하여 구현할 수 있다. 모든 연산자 계산 순서 등도 모두 동일해야 가능하기 때문이다.(락스텝: 모든 유저가 프레임을 동기화하고 Input을 공유한다)
        * 오버워치의 경우 리플레이가 정확히 유저가 했던 행동과 일치하지 않는다. 얘네들은 키 프레임을 잡아 결과만 동일하게끔 리플레이를 구현하였다. 

## 스레드 프로그래밍
### 선점과 비선점
1. 기준: 스레드를 중간에 중단될 수 있느냐 없느냐!
2. 모든 OS는 선점형이어야 한다. 만약 무한 루프 스레드가 있는 경우 멀티스레드 불가능

### 유저와 커널 스레드
1. 유저 스레드
    1) OS가 개입하지 않는 유저 스레드
    2) 유저 스레드는 병렬로 실행되지 않는다. 유저 스레드는 별도의 스택이 제공되지만 개별적으로 코어를 할당받아 병렬적으로 처리되지 않는다.
    * C++ 2020에서는 API 퐈이버를 제공한다.
    * 일드: 유저 스레드에서는 일드를 하여 현재 동작을 중지시키고 다른 스레드를 동작시키러 간다.
2. 커널 스레드
    1) OS가 개입하여 스레드를 병렬적으로 수행하는 스레드
    2) CPU

### 프로세스
1. 콜스택: 스레드마다 스택이 생성된다. 이는 IP 레지스터를 바탕으로 분석되어 콜스택 디버깅 창에 표시된다.
2. CPU 상태: CPU 레지스터, 엄밀히 따지면 스택 정보도 CPU 상태에 포함이 된다.
    * 64bit에서는 위험하다는 이유로 inline 어셈을 막아놨다. 32bit에서는 가능
3. 가상메모리(=프로세스 메모리) 테이블은 커널 메모리 영역에 들어있다. 커널에서 프로세스에 대한 정보가 구조체로 관리된다.

### 멀티 스레드
1. 사용자 응답성 개선: 게임 로딩 모래시계
2. 프로그램 구조적인 개선: 기능들의 분리, 무한 루프 등의 문제 해결
3. 서버를 설계할 때 스레드의 개수를 고려하여 CPU를 선택하던지 CPU를 고려하여 스레드 구조를 결정해야 한다.

## 기타 키워드
### 퍼블리셔
1. 리텐션: 광고 대비 돌아오는 유저 수
2. 요즘 개발사는 보통 퍼블리셔와 계약하여 게임을 제작하는 것이 일반적이다.
3. 요즘 퍼블리셔들은 안 될것같은 게임을 펀딩하여...

### 유니티
1. 코루틴 - 유저 스레드
2. API 퐈이버 - 
