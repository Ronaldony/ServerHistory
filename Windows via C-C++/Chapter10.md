# Chapter10 동기 및 비동기 장치 I/O
## 들어가기에 앞서
### 동기와 비동기 I/O
1. 스레드가 동기적인 장치 I/O를 요청하면 I/O 작업이 완료될 때 까지 해당 스레드는 블로킹 상태가 된다. 이는 수행 성능에 나쁜 영향을 미치게 된다.
2. I/O 컴플리션 포트(aka IOCP): 매우 잘 정제된 스레드 간의 통신 매커니즘, I/O 수행 시 응답을 대기할 필요가 없다. 최초 IOCP는 장치 I/O에만 적용하게 설계되었지만, 시간이 지나면서 OS의 다양한 기능들을 하나하나 IOCP와 통합하였다.

## Section01 장치 열기와 닫기
### 장치의 특성
1. 본 책에 Page 389 표 10-1에서는 장치들의 각 특성을 표로 정리하였다.
2. 윈도우는 각 장치들 간의 차이점을 가능한 한 개발자에게 드러내지 않으려고 한다. 이렇게 함으로써 장치를 한 번 열기만 하면 장치에 대한 읽기, 쓰기를 수행하는 함수들은 장치의 종류와 상관 없이 동일하게 사용될 수 있다.

### 장치 열기 함수
1. 본 책에 Page 389 표 10-2에서는 장치들의 열기 함수들을 표로 정리하였다.
2. GetFileType
    <pre><code>
    // 입력한 핸들의 파일 타입을 반환해주는 함수                       
    // FILE_TYPE_UNKNOWN(0x0000) 반환 시 GetLastError()로 오류 코드를 확인할 수 있다.
    DWORD GetFileType(
        HANDLE hFile
    );
    </code></pre>
3. I/O의 캐시(임시 버퍼)를 없애면 해당 디바이스 드라이버

### CreateFile 함수
1. 플래그
    1) FILE_FLAG_OVERLAPPED: 해당 장치에 대하여 비동기적으로 I/O를 한다고 시스템에 알린다.

## Section03 동기 장치 I/O 수행
### 동기 I/O
1. hang 증상: 여러 원인이 있지만 그 중 동기 I/O에 의해 발생되기도 하는 현상. 시스템, 네트워크, 어플리케이션이 동작하지 않고 서비스가 응답하지 않는 상태
2. CancelSynchronousIO
    1) 기능: 지정한 스레드가 동기 I/O 작업의 완료를 대기하고 있었다면 해당 스레드는 수행을 재개하게 되고, 요청한 동기 I/O 작업은 실패하였음을 나타내는 값을 반환한다.
    <pre><code>
    BOOL WINAPI CancelSynchronousIo(
        HANDLE hThread
    );
    </code></pre>
    
## Section04 비동기 장치 I/O의 기본
### 비동기 I/O
1. 비동기 I/O 요청: 스레드가 비동기 I/O 요청 시 실제로 I/O 작업을 수행할 장치의 디바이스 드라이버로 전달된다. 이때 디바이스 드라이버가 장치로부터의 응답(처리)를 대기해 주기 때문에 L7의 어플리케이션은 I/O 요청 완료를 대기하지 않고 다른 작업을 계속 수행한다.
    * 디바이스 드라이버가 I/O 요청 작업에 대한 결과(송수신 완료 여부, 에러 발생 등)를 통지해 주는데 L7 단계에서 이 결과를 어떻게 처리해야할지 고민해봐야 한다.

### 비동기 장치 I/O 사용 시 주의점
1. 주의점
    1) 첫 번째: 디바이스 드라이버는 일반적으로 수행 성능을 개선시키기 위해 I/O 요청을 순서에 따라 수행하지는 않는다.
        * 파일시스템 드라이버의 경우 디스크의 헤드를 움직이는 시간 및 검색 시간을 줄이기 위해 I/O 요청 목록을 검토하여 하드 디스크의 현재 위치로부터 물리적으로 가장 가까운 위치에 대한 I/O 요청을 먼저 수행할 수 있다.
    2) 두 번째: 에러 확인을 수행하는 코드가 마련되어야 한다.
    3) 세 번째: I/O 요청에 사용된 버퍼를 I/O가 작업중인 상황에서 제거(동적 할당인 경우)하면 안되고 접근 시 동기화에 대한 고려가 이루어져야 한다. 이와 같은 이유는 드라이버가 I/O 요청 처리 시 사용자로부터 입력된 버퍼의 주소에 접근하여 직접 쓰고 읽기 때문이다.

## Section05 I/O 요청에 대한 완료 통지의 수신
### I/O 완료 통지 수신 방법
1. 윈도우는 4가지 서로 다른 방법으로 I/O 완료 통지를 받을 수 있다.
    |방법|요약|
    |---|---|
    |디바이스 커널 오브젝트의 시그널링|특정 스레드가 I/O 요청을 삽입하고 다른 스레드가 완료 통지를 수신할 수 있다. 단일 장치에 대해 다수의 I/O 요청 수행에 적합하지 않음|
    |이벤트 커널 오브젝트의 시그널링|위와 동일. 그러나 단일 장치에 대해 다수의 I/O 요청 수행 가능|
    |얼러터블(Alertable) I/O|항상 I/O 요청을 삽입한 스레드가 완료 통지를 수신한다.|
    |I/O 컴플리션 포트|특정 스레드가 I/O 요청을 삽입하고 다른 스레드가 완료 통지를 수신할 수 있다. 이 방법이 가장 확장성이 뛰어나고 유연성이 있다.|
