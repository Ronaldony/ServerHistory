# 2022/04/15 수업내용
## TCP 파이터 서버
### 유저의 연결
1. 프린트물에 있는 코드는 '프로세싱 루프'와 '삭제 루프'를 분리하지 않은 코드이다. 하지만, 이는 좋은 코드가 아니다. 분리하는 것이 좀 더 깔끔하게 떨어지는 코드가 될 것이다.
    * 소켓 에러 혹은 세션 에러 발견 시 바로 끊어버리는 것은 문제가 있다. 다른 곳에서 Iterator를 통해 해당 세션 정보를 참조하다가 문제가 일어날 수 있기 때문이다.
2. 방을 파괴하는 시점
    1) 유저가 나가는 시점(세션이 끊기는 시점)에 판단하는 것
        * 하나하나의 유저가 나갈때마다 방이 파괴된다 라는 조건을 판단하는 것은 코드가 복잡해지고 애매하다.
    2) 게임 종료, 승리, 방을 파괴하는 시점을 각각 따로 분리하여 조건들을 확인 후 파괴하는 것이 더욱더 로직을 간결하고 깔끔하다.
      * 실제로 방이 파괴하고 정리하는 코드는 단 하나여야 한다는 의미이다!

### 패킷 프로시저 함수
1. 언제든 함수 포인터, 일반 호출 등의 동작으로 전환하기 위하여 프로시저 함수는 항상 패킷 하나당 하나의 함수 그리고 리턴 타입, 매개변수를 항상 일관된 형태를 가져가도록 한다.

### 더미
1. 더미 프로그램은 어디에 도착했다가 아니라 플레이어와 동일하게 걷도록 구현해야 한다. 그 이유는 다음과 같다.
    1) 사실 굳이 더미 입장에서는 연속적으로 걸어다니지 않아도 된다. 이유는? 서버에서 플레이어가 움직임을 시작한 시점만 정확히 알고 있다면 시간 혹은 지나간 프레임을 기준으로 이동속도를 계산하여 어디에 위치했는지 알 수 있기 때문이다.(데드레커닝) 이것은 위치와 충돌 처리 등에 적용될 수 있다. 따라서, 더미는 최종 목적지만 공유하는 형태로 만들어도 된다. 하지만! 이같은 방법은 치명적인 단점이 있다. 아래에 이어서 설명하겠다.
    2) 이러한 방법은 MO 환경에서는 적절할 수도 있다. 하지만 MMO 환경에서는 이러한 방법은 절대 불가능하다. 모든 맵에 있는 유저에 대하여 처리해야하는 서버의 입장에서는, 특정 상황마다 플레이어의 위치 계산이 이루어질 때 굉장한 부하가 몰릴 수 있다. 따라서, 플레이어를 지속적으로 걸어다니게 하여 부하가 몰리는 것을 예방할 수 있다.
       * 서버는 예측가능한 부하가 되는 것을 선호한다. 

### 조작감과 유저의 조작
1. 내가 키를 눌렀을 때에 대한 반응이 있어야 조작감이 있다고 판단한다.
    * 키보드 조작: 키보드를 눌렀을 때 바로 동작을 취해야 조작감이 좋다고 느낀다. 하지만 좌표를 동기화하는 것은 기획단계에서부터 결정되어야 한다.
    * 마우스 조작: 클릭 지점에 이펙트만 띄어도 조작감이 있다고 느낌. 실제로 클릭에 대한 행위가 500ms 이후에 시작되도 유저는 조작감이 있다고 느낀다.
2. 우리가 TCP 파이터에서 클라이언트의 좌표를 믿는 이유는 조작감을 위해서이다. 본 게임에서 만약 서버의 좌표를 믿게 된다면 클라가 이동을 멈출 때 앞으로 밀려나 유저의 조작감을 떨어뜨린다. 이러한 문제를 해결하기 위하여 클라의 좌표를 믿게 만든 것이다. 하지만 실제 게임에서는 이러한 방법을 절때!! 사용하지 않는다.
    * 밀려나는 근본적인 이유는 조작 클라는 키를 때는 순간 캐릭터가 멈추지만, 서버와 다른 유저들은 Stop 패킷이 전달된 후 멈추는 것을 판단하기 때문이다.
3. 공격
    1) 클라로부터 스킬 메시지가 왔을 때 해당 스킬이 특정 모션 이후 공격을 하는 경우라면 서버에서도 실제로 모션 이후에 충돌처리를 진행해야 한다.
4. 클라의 조작을 의심하고 판단하는 과정
    1) 공격, 이동 메시지 등 비정상적인 메시지가 수신되는 것이 확인되었다.
    2) 하지만 이게 RTT로 인해 발생되는 것인지 정확히 알 수 없다.
    3) 이때는 반복 행동, 시간 등의 기준을 기획자 또는 협업자와 상의하여 결정해야한다. (최대한 유저의 불만도 해결하는 방향으로 가야함 = 납득이 가게)
    * 사실 이러한 상황이 발생하였을 때 네트워크, 클라, 서버의 문제일 수가 있다. 때문에 서버의 입장에서는 이 문제를 완벽하게 처리하기가 애매한 부분이 있다. 따라서, 보안팀, 기획자와의 협의를 통해 이러한 사항을 해결해야 한다.

### 목적지의 공유
1. 조작이 어떠한 방식이던 미래의 목적지 좌표를 공유하여 네트워크 레이턴시가 있다해도 유저들의 좌표 싱크를 맞출수가 있다.
2. 요즘 게임에서는 미래의 목적지 좌표가 아닌 객체에 특정 힘을 가해서 움직이는 형태로 간다.

### 섹터(= 클러스터 혹은 파티션)
1. 섹터의 주 목적: 해당 플레이어를 기준으로 네트워크 전송(메시지 전송)의 범위를 제한하는 것
2. 크기: 한 플레이어당 기본적으로 현재 위치를 기준으로 상하좌우, 위아래 대각선 9개의 섹터를 할당한다.
3. 섹터 영역에 무수히 많은 유저가 동시에 존재할 때 서버의 동작, 발생하는 문제, 해결 방법 등을 고민하여 결론을 내야 한다.
4. 클라가 이동해서 섹터의 영역이 옮겨질 때 다른 클라에서 특정 행동을 하고 있을때 그 행동을 자연스럽게 이어가면서 해야한다.
5. 공격
   1) 공격과 충돌이 발생 시 공격 메시지는 공격자 섹터 영역의 플레이어에게 전달해야 하고, 데미지 메시지는 피격자 섹터 영역의 플레이어들에게 전달해야 한다.

### 섹터의 사이즈
1. 시야 범위를 유저 수에 따라 유동적으로 바꾼다. => 섹터의 사이즈를 바꾼다? 절대 아님. 해결 방법은 섹터 영역의 범위를 바꾸는 것이다.
