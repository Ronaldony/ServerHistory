# 2022/05/27 수업내용
# 비동기 IO
## Alertable wait IO (APC 큐)
## 비동기 IO
1. Event, Alertable wait, IOCP 방식 모두 동일하게 완료 통지를 Block 상태로 대기해야 한다. 애초에 완료 통지를 기다리는 스레드에서 다른 작업을 하게 설계한 것이 잘못된 것이다.
    * Alertable wait은 단지 비동기 IO를 요청한 스레드가 완료 통지를 받아야하는 큰 단점일 뿐이다.
2. WaitForMultipleObjectsEx, WaitForSingleObjectEx 등의 함수들은 Event와 Alertable wait 방식 둘 다를 지원한다.

## TCP 예제 분석
### ACP 큐
1. 전역에다 소켓을 두고 Accept 스레드와 Worker 스레드가 한 번씩 핑퐁 방식으로 전급하여 사용하고 있다.
    1) 이 예제에서 소켓을 사용한 방법은 정상적인 방법은 아니다. 정상적인 방법은 Accept 스레드가 Worker 스레드의 메시지 큐를 통해 데이터를 전달하는 형태가 될 것이다.
2. Worker 스레드 내부에서 while(1)을 두 번 겹쳐서 하는 이유 
    1) 이 예제에서 Worker 스레드는 신규 사용자에 대한 처리(Recv 등록 등)와 완료 통지에 대한 처리를 하는 것이다. 따라서 WaitForMultipleObjects로 기다릴 때 신규 사용자에 대한 처리로 인해 Block 상태 해제 시 그에 대한 처리를 하기 위해 while문을 빠져나가 뒷처리를 하게 된다. 반대로 완료 통지로 인한 Block 상태 해제면 완료 루틴에서 상응하는 작업을 마치고 난 뒤 Block이 해제되는 것이므로 다시 WaitForMultipleObjects를 호출하여 Block 상태로 진입니다.
3. 완료 통지 시 Overlapped 구조체를 가지고 송수신인지에 대한 파단 및 IO에 대한 결과를 분석해야 한다.
    1) 예제에서는 완료루틴 내부에서 인자로 전달받은 OVERLAPPED 구조체를 세션 정보 구조체로 마샬링하여 세션 정보에 접근하여 소켓 정보를 읽어온다. (세션 정보 구조체의 첫 번째 요소가 OVERLAPPED 구조체이다.)

# 기타 키워드
## 과제
### 스레드 관련
1. 첫 번째 과제
    1) 과제: 멀티 스레드 환경에서 하나의 링버퍼를 대상으로 하나는 EnQ, 하나는 DeQ를 할 때 Lock 동기화 없이 정상적인 수행을 할 수 있도록 링버퍼를 수정하고 링버퍼에 멤버 변수로 SRWLOCK을 추가하고 멤버함수로 Lock과 Unlock을 추가한다.
    2) size와 같은 부가적인 요소는 Interlocked의 대상이지 Lock의 대상이 아니다.
    3) 만약 DeQ를 시도했을 때 
    4) 두개 이상의 스레드가 EnQ, 두개 이상의 스레드가 DeQ를 했을 때 
    5) 우리는 EnQ하는 상황과 DeQ하는 상황을 
2. 두 번째 과제: 이전에 했던 멀티 스레드로 헤테로 지니어스 구조로 숫자 순서대로 출력, 데이터 입력 등의 기능을 구현했다. 이번에는 호모 지니어스 구조의 Actor 패턴을 이용하여 생산자 스레드가 워커 스레드에 잡을 던져 하나의 스레드에서 모든 일을 하게 설계한다. 워커 스레드는 여러개가 될 수 있다.
    1) DB와 관련된 워커 스레드가 느린 경우 워커 스레드의 큐에 메시지가 쌓일 수가 있다. 이때 어떤 방안으로 대처할 수 있나? 
        * 방안1: 중요한 메시지는 처리하고 중요하지않은 메시지는 버려야 한다. 그리고 메시지 큐에는 애초부터 중요한 것과 중요하지 않은 메시지를 큐로 분리되어야 한다. => 그래서 잡 큐는 모니터링의 대상이다. 상승 곡선의 그래프가 나오면 결국에는 메모리가 가득차게 되어 있다.
        * 방안2: 
        * 메모리를 계속해서 늘리는 방법은 좋은 방법은 아니다. 그러나 이 상황은 이후에도 메시지 큐는 계속해서 발생한다.
        * 극단적인 방법1: 생산 자체를 줄이는 방법이다. 특정 유저들을 끊어버리거나 의도적으로 프레임을 줄이는 것.
        * 극단적인 방법2: 서버를 죽이는 것
3. 세 번째 과제: 디버깅, 문제되는 상황을 파악하고 그것이 어떤 상황에서 벌어질 수 있는가를 역추적하여 어떤 코드인지 파악하기
    1) 적어올 상황: 어디를 수정했는지, 어느 코드가 어떤 문제를 발생시킨 것인지
4. 멀티 스레드에서 문제가 발생했을 떄 절대 코드를 수정하지 않는다. 문제가 발생하는 순간을 정확히 로그를 남겨 
    1) 그 상태에서 값 확인, 원인 파악 정확히 한 후 코드를 수정하고 테스트까지 완료하기
