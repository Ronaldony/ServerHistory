# 2022/02/25 수업내용
# 소켓 프로그래밍
## Chapter10 소켓 입출력 모델(1)
### 소켓 모드의 종류
1. 논블로킹 소켓 사용시 accept, send, recv는 지금 당장 작업을 수행하지 못하면 에러를 뱉어낸다. connect는 3 handshake가 L4에서 비동기적으로 이루어지기 때문에 무조건 에러를 뱉어낸다.
    * GetLastError를 호출하여 에러 코드를 확인해야 한다. 대개 WOULDBLOCK이다.
2. ioctlsocket
    1) 소켓 특성 지정
    2) FIONBIO: 논블로킹 소켓으로 변경

### 소켓 함수 오류
1. send 함수의 오류
    1) send가 WOULDBLOCK 나오는 경우는 송신 버퍼 소켓이 가득찬 경우이다.
    2) 송신 요청 크기보다 작은 값을 반환하는 경우 연결이 끊기거나 하는 경우가 있다. 따라서, 적게 나오는 경우에 대한 대비 코드를 짜놓아야 한다.

### 소켓 입출력 모델의 종류
1. Select: 오래됐지만 무시할 대상이 아니다. 아직도 현역임(언리얼 데디케이트 서버 등..)

### Select 모델
1. 소켓 셋
    1) 읽기 셋: 수신된 것들에 대한 상태 (백로그, 수신 버퍼 등..)
    2) 쓰기 셋: 송신 버퍼에 대한 상태
    3) 예외 셋: OOB, 에러 상태 등의 정보(ex: connect 이후 예외 셋이 set되면 오류), 우린 잘 사용하지 않을 것
2. 소켓 셋의 최대 크기는 64개이다.
    * 우리는 기본 값인 64개를 사용한다. 초과하여 사용 시 어떠한 문제가 발생할 수 있는 가능성이 있기 때문(이건 명확히 언급하진 않으심)
3. 소켓 셋 사용 절차
    1) select 호출 시 소켓 셋 입력
    2) 반응이 있던 소켓 셋만 남게됨
4. 예외 셋을 쓰지않는 이유
    1) 예를 들어 connect 후 예외 셋을 확인하고 연결이 됐다면 쓰기 셋을 확인 후 send를 호출한다. 이는 연결이 확실히 확인되어야만 하는 상황이라면 사용할 수 있지만 우리의 입장에서는 필요가 없다. 왜냐하면 send는 소켓이 성공적으로 연결만 되었다면 반응이 오지 않을수가 없기 때문이다.(즉, 송신 버퍼가 가득 차는 경우가 거의 없다.)

### select 함수
1. timeout 이내 소켓 셋에 반응이 오면 반환
2. 입력 인자
    1) fd_set: 소켓 셋 뭉텅이
    2) timeval: 
3. 반환 값: 
    1) 양수: 반응을 보인 소켓 셋 갯수
    2) SOCKET_ERROR: 소켓이 아닌 것을 넣는 경우 (이미 closesocket이 이루어진 소켓)
        * 이후에 벌어질 상황(녹음 다시 듣기)
    * 보통 우리는 0 이상인 경우와 SOCKET_ERROR를 확인한다.
4. fd_set 매크로
    1) FD_ZERO: 소켓 셋을 비운다.
    2) FD_SET: 입력한 소켓이 소켓 셋에 있는지 확인
    3) FD_CLR: 입력한 소켓을 소켓 셋에서 삭제
    4) FD_ISSET: 해당 소켓이
    * fd_set 구조체를 직접적으로 건드리는 것은 좋지않은 접근이다. 원칙적으로 fd_set은 가려진 형태이기 때문에 언제든 바뀔 수 있기 때문이다.
5. select 모델임에도 Non-Block 소켓을 사용해야하는 이유
    1) send의 특성
        * send의 경우 송신 조건을 명확히 알려주지 않아 Non-block 소켓을 사용하여야 한다.

### 세션
1. 세션의 단위
    1) 컨텐츠: 유저
    2) 네트워크: 연결
2. L7에서의 송수신 버퍼
    1) L7 수신 버퍼 존재의 이유: TCP에서 쪼개지거나 뭉쳐서 올 수 있기 때문에 그에 대비하기 위함
    2) L7 송신 버퍼 존재의 이유: 못 보낼 때를 대비하기 위함. 매번 보내고자 할 때마다 보내는 것이 아닌 모아서 보내기 위함
        * send 함수는 느리다.

### 서버 입장에서의 select
1. 소켓 셋
    1) write 셋의 경우 대부분 반응이 오기 때문에 write 셋을 통해 send를 하지 않는다.
        * write 셋의 반응이 오지 않는 경우 정상적인 상태가 아니다!
        * send 시도 시 요청 크기보다 작은 값이 반환되거나 에러가 나는경우 비정상 상태!
        * 위와 같은 이유로 우리에게 write 셋은 필요가 없다. 하지만 정석대로라면 write 셋을 써야한다.
2. 송수신 버퍼
    1) 송수신 버퍼 구조 시 링버퍼로 만들어야 한다. 이는 TCP의 스트림 방식으로 인하여 생겨난 구조이다.

### 버퍼의 수신
1. recv 호출 시 요청한 크기보다 작은 크기가 반환되는 경우(데이터가 조각남)
    1) 요청 크기를 10 byte 라고 가정
    2) 송신측이 send(10)을 하였는데 수신측에서 제로 윈도우가 발생한 시점 직전 수신 버퍼 공간 5만큼 남은 경우 
    3) 송신측 송신 버퍼의 남은 공간이 10 보다 작은 경우
    * 그러나 보통 조각나는 건은 없다.

## 기타 키워드
### 메모리 에러
1. WSA_NO_BUFFER
    * 컴퓨터의 자원의 고갈로 인해 발생하는 경우가 많음(RAM, NP 풀 등..)
2. DISK 에러

### UDP
1. UDP의 경우 L7 차원에서의 수신 버퍼가 필요 없다.

### select 모델의 한계
1. 언리언 데디케이트 서버와 같이 하나의 게임만 관장한다면 select 모델이 효율적이지만, 여러개의 게임을 관장하며 

### 과제
1. select 모델을 사용한 Echo 서버-클라 만들기
