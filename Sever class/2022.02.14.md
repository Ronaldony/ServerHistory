# 2022/02/14 수업내용
## 소켓 프로그래밍
## Chapter04 
### TCP서버-클라이언트 실습
1. listen 함수는 통신 하기 전 필요한 작업을 모두 수행한 후 서버 가동이다 하는 지점에서 호출되어야 한다.
2. accept 함수로 얻어진 클라의 IP, 포트를 항시 저장하여 유저 관리할 것

### TCP 서버-클라이언트 분석
1. bind 함수의 sockaddr name의 IP와 포트 입력
    1) 0.0.0.0(INADDR_ANY): 컴퓨터에 등록된 모든 LAN 어댑터 IP로 들어오는 연결을 모두 수용한다.
    2) 특정 IP와 포트: 서버, 유저용 Listen 소켓을 나눌 때 사용된다.
        * 일반적으로 bind 시 INADDR_ANY로 지정한다.(사설 IP는 컴퓨터마다 달라져 변경이 필요하기 때문) 그러나 크리티컬한 부분이라면 유저용은 공인IP, 서버는 사설IP(192.168.x.x...)로 지정한다. 
        * 만약 127.0.0.1로 bind하면 나의 사설 IP(192.168.x.x...)로도 접속하지 못한다. 따라서 Loopback으로 bind하는 것은 같은 PC의 프로세스간 통신 시 사용된다.
    * 보통 bind 함수는 Port 중복으로 인하여 실패하는 경우가 많다.
2. listen 함수
    1) 사실 accept가 아닌 **listen 함수가 호출되는 시점**에서 클라에서 connect 함수가 호출되면 **3 handshaking 동작**을 수행하고 ESTABLISHED 상태가 된다. listen이 정상적으로 동작되지 않는 경우는 backlog 큐가 가득 찬 경우
    2) Backlog 큐: 연결된 상태를 저장하고 있는 대기열. L4 계층에서의 동작이다. (게임 접속 대기열과는 다른 개념) 기본적으로 OS에서는 최대 Backlog 큐의 길이는 65535이다.
    * Listen 소켓은 일반 유저용과 서버간 접속용으로 **분리**되어야 한다. 나중에는 일반 유저 네트워크 클래스와 서버 네트워크 클래스를 분리하게 된다.
    * <img width=550 src="https://user-images.githubusercontent.com/95362065/153834524-5da817dd-4209-4d4d-a5d4-db115d1ad7d4.png">
3. accept 함수
    1) Backlog 큐에 저장된 연결 정보(이미 3 handshaking된)를 가져와 새로운 소켓과 연결하여 리턴한다. 만약 Backlog 큐에 연결 정보가 없으면 해당 스레드가 Blocked 상태가 된다.
4. connect 함수
    1) 3 handshake 마지막 ACK를 보낸 후 return 한다.
    2) 함수 내부에서 어느 이더넷으로 나갈 지 routing 과정을 거친다.
    3) connect 실패 원인
        * 원인1: 서버측 backlog 큐 꽉 참 => connect 즉시 반환 후 오류 코드 출력
        * 원인2: 서버측 listen 상태가 아니거나 SYN 응답이 오지 않음 => connect 즉시 반환하지 않고 SYN 패킷 재전송 절차 거침
    4) 나중에 네트워크 프로그램 시 connect 처리 속도를 초당 1500정도로 잡을 예정
5. send 함수
    1) Block: L7에서 요청한 크기보다 송신 버퍼가 작은경우 Blocking 된다.
    2) Non-block: L7에서 요청한 크기보다 송신 버퍼가 작은경우 송신 버퍼의 여유만큼만 복사하고 함수가 반환된다.
        * Non-block 사용 시 L7 계층에서의 전체 버퍼가 송수신 소켓 버퍼에 복사가 제대로 되었는지 확인하는 후속 처리가 필요하다.
6. recv 함수
    1) 리턴 값: 연결 해제 과정(FIN~CLOSED)인 경우 0을 반환한다. 0 혹은 SOCKET_ERROR 등의 함수 실패는 연결 끊김으로 후속 처리 한다.

### 연결
1. 서버-클라 연결 실패 시 확인 절차
    * 클라-서버 연결 실패 시 확인 절차: 서버측 Listening 연결 상태->방화벽->Ping->서버에 SYN 패킷 수신 여부 등..
2. 통신은 최소한 통신 순서를 보장하여야 한다.
3. 보내고 끊기가 필요한 경우가 되게 애매하다.
    1) 접속 중 로그인(중복 로그인)
    2) 계정 정보 틀림
    * 서버 L7에서 보낸 정보를 클라 L7에서 받았는지 모르기 때문이다.
4. 클라의 종료 요청이 정상적이든 비정상적이든, 무조건 비정상적인 종료 하나로 처리하여야 한다.

## 기타 키워드
### connect와 포트 번호
1. 주의!! 시스템에서는 기본적으로 프로그램에서 connect 요청 시 **동적 포트 범위 49152번 ~ 65535번 안에서 포트 번호를 부여**한다.
2. 레지스트리 키를 등록하여 프로그램에서 할당받을 수 있는 포트 번호의 범위를 넓혀줄 수 있다. 최대 등록된 포트 번호 1024번 ~ 49151번을 늘릴 수 있다.
    * 링크: https://docs.microsoft.com/ko-kr/troubleshoot/windows-client/networking/connect-tcp-greater-than-5000-error-wsaenobufs-10055

### 과제
1. 소켓 프로그래밍 Page 94~100 프로그램 짜고 테스트 하기
2. 내 컴퓨터의 Backlog 큐를 알아오기(모든 과정, 코드 기록하기), 기본 개수, 늘릴 수 있는 방법 및 개수, 실제 늘어난 개수 확인하기
