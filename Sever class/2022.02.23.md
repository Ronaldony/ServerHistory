# 2022/02/23 수업내용
# TCP/IP 소켓 프로그래밍
## Chapter08 소켓 옵션
### SO_SNDBUF, SO_RCVBUF
1. setsockopt 으로 지정한 값이 정확하게 설정되지 않는다. 
    * 따라서 L7에서 송수신 버퍼를 0으로 만들 수 없고, L7에서 완벽히 제어할 수 없다. (오버랩에서는 0으로 설정 가능)
    * OS 입장에서는 최소한의 크기만 보장해주면 문제가 없기 때문에 문제는 없는 것이다.
2. 기본 송수신 버퍼 크기는 64KB이다.

### Block, Non-Block 소켓
1. 서버에서 모든 소켓 프로그램은 논블록 소켓을 사용할 것이다.
    * 비동기 시에는 제외(블럭, 논블록 개념이 사라지기 때문)
2. Listen 소켓에 설정하면 새로 생성되는 소켓들에 같은 설정이 복사된다. 따라서, Listen 전에 소켓 옵션을 조정할 것(연결이 체결된 후 소켓 옵션 설정 시 안 먹힘) 

### SO_SNDTIMEO, SO_RCVTIMEO
1. 네트워크 끊김 문제에 대하여 해결해야 할 때 100% 보장된 코드를 사용하는 목적으로 사용되기도 한다.

### recv와 send
1. 서버 입장에서는 수많은 유저의 일일히 recv, send를 해서 소켓의 상태를 확인하는 것은 비효율적이다. 소켓 모델을 사용하면 recv, send 타이밍을 알 수 있다.
2. 대량으로 쏟아부으면 LAN, Loopback 환경에서도 패킷 유실, 연결 끊김이 즐비하게 일어난다.

### LAN
1. 패브릭 네트워크: 모든 컴퓨터는 격자로 연결되어 있다. 백본 스위치에 많은 컴퓨터를 설치하고 소프트웨어 단에서 LAN 환경을 구축한다.
    * 성능은 떨어진다.
2. LAN이 끊기는 경우의 문제점 파악
    1) 코드 측면: 100% 오작동이 없는 코드를 가지고 LAN에 연결된 양 호스트의 통신을 시도해봐야 한다. 이때는 Block 소켓을 사용하는 것이 좋다.

### TIME_WAIT
1. 더미 클라이언트측에서 서버와 연결 종료 시 TIME_WAIT 상태가 남으면 포트 번호 문제가 발생할 수 있다.

### 멀티 캐스팅
1. 일부 지정된 클라에게만 뿌린다! IGMP 프로토콜을 사용하여 구현된다. 하지만 우리는 쓸 일이 없다. 라우터를 빠져나갈 수 없기 때문이다.
2. 멀티 캐스팅 IP: 지정된 IP로 어느 공간, 그룹에나 존재하는 IP이다.
3. IP TV에서 주로 사용된다. 멀티 캐스팅을 지원하는 공유기를 사용하여야 사용이 가능하다.

### 네이글 알고리즘과 IPPROTO_TCP
1. 송신된 데이터 길이에 대응되는 ACK 번호가 수신되면 그때 송신 버퍼에서 ACK 번호에 해당하는 만큼 없어진다.
2. 네이글 알고리즘으로 인해 TCP가 슬라이딩 윈도우가 핑퐁처럼 보일수도 있지만 헷갈리면 안된다.
    * 윈도우에 핑퐁은 없다!!!
3. TCP_NODELAY: 네이글의 작동 여부, 프레임이 중요한 경우 네이글을 꺼야하지만 네트워크 트래픽에 대한 부담이 있다.

### 소켓 모델, select 모델
1. 소켓 모델, select 모델은 프레임 단위로 데이터를 모아서 클라에게 send 한다.

## 실습
### setsockopt, getsockopt 실제 동작
1. 수신 버퍼가 윈도우 사이즈만큼 처음부터 NP 풀에 할당되느냐? 아니면 페이지 락을 걸어서 동적으로 할당되느냐?
    * 결론: 상대 호스트에서 데이터가 수신되면 그때 동적으로 NP 풀이 증가된다.7

### 4 Handshake
1. CLOSE_WAIT 상태에서도 수신 버퍼로 들어온 데이터는 recv로 수신된다.
2. 서버가 send로 데이터를 전송하고 Linger 옵션을 사용하여 RST 패킷을 보낸 상황이다. 이때 클라가 RST 패킷을 받았다면 recv를 했을때 수신 버퍼와 상관없이 SOCKET_ERROR가 발생한다.(세션 리소스가 소멸됨)

## 기타 키워드
### AWS
1. LAN 네트워크가 가끔 끊긴다. 하지만 AWS는 정상이라고 주장함

### 보내고 끊기가 잘 안되는 이유 확인해보기
