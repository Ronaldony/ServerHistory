# 2022/02/14 수업내용
## 소켓 프로그래밍
## Chapter04 
### TCP서버-클라이언트 실습
1. listen 함수는 통신 하기 전 필요한 작업을 모두 수행한 후 서버 가동이다 하는 지점에서 호출되어야 한다.
2. accept 함수로 얻어진 클라의 IP, 포트를 항시 저장하여 유저 관리할 것

### TCP 서버-클라이언트 분석
1. bind 함수의 sockaddr name의 IP와 포트 입력
    1) 0.0.0.0(INADDR_ANY): 컴퓨터에 등록된 모든 LAN 어댑터 IP로 들어오는 연결을 모두 수용한다.
    2) 특정 IP와 포트: 서버, 유저용 Listen 소켓을 나눌 때 사용된다.
        * 일반적으로 bind 시 INADDR_ANY로 지정한다.(사설 IP는 컴퓨터마다 달라져 변경이 필요하기 때문) 그러나 크리티컬한 부분이라면 유저용은 공인IP, 서버는 사설IP(192.168.x.x...)로 지정한다. 
        * 만약 127.0.0.1로 bind하면 나의 사설 IP(192.168.x.x...)로도 접속하지 못한다. 따라서 Loopback으로 bind하는 것은 같은 PC의 프로세스간 통신 시 사용된다.
    * 보통 bind 함수는 Port 중복으로 인하여 실패하는 경우가 많다.
2. listen 함수
    1) 사실 accept가 아닌 **listen 함수가 호출되는 시점**에서 클라에서 connect 함수가 호출되면 **3 handshaking 동작**을 수행하고 ESTABLISHED 상태가 된다. listen이 정상적으로 동작되지 않는 경우는 backlog 큐가 가득 찬 경우
    2) Backlog 큐: 연결된 상태를 저장하고 있는 대기열. L4 계층에서의 동작이다. (접속 대기열과는 다른 개념)
    * Listen 소켓은 일반 유저용과 서버간 접속용으로 **분리**되어야 한다. bind 시 IP와 Port 번호를 나누어야 한다.
    * 나중에는 일반 유저 네트워크 클래스와 서버 네트워크 클래스를 분리하게 된다.
    * <img width=550 src="https://user-images.githubusercontent.com/95362065/153834524-5da817dd-4209-4d4d-a5d4-db115d1ad7d4.png">
3. accept 함수
    1) Backlog 큐에 저장된 연결 정보(이미 3 handshaking된)를 가져와 새로운 소켓과 연결하여 리턴한다. 만약 Backlog 큐에 연결 정보가 없으면 해당 스레드가 Blocked 상태가 된다.
4. connect 함수
    1) 3 handshake 마지막 ACK를 보낸 후 return 한다.
    2) 상대방이 LSTENING 상태가 아니거나 상대방으로부터 SYN+ACK가 오지 않는 경우 연결 시도를 재전송한다.
5. send 함수
    1) Block: L7에서 요청한 크기보다 송신 버퍼가 작은경우 Blocking 된다.
    2) Non-block: L7에서 요청한 크기보다 송신 버퍼가 작은경우 송신 버퍼의 여유만큼만 복사하고 함수가 반환된다.
        * Non-block 사용 시 L7 계층에서의 전체 버퍼가 송수신 소켓 버퍼에 복사가 제대로 되었는지 확인하는 후속 처리가 필요하다.
6. recv 함수
    1) 리턴 값: 연결 해제 과정(FIN~CLOSED)인 경우 0을 반환한다. 0 혹은 SOCKET_ERROR 등의 함수 실패는 연결 끊김으로 후속 처리 한다.

### 연결
1. 서버-클라 연결 실패 시 확인 절차
    * 클라-서버 연결 실패 시 확인 절차: Listening 연결 상태->방화벽->Ping->서버에 SYN 패킷 수신 여부 등..
2. 통신은 최소한 통신 순서를 보장하여야 한다.
3. 보내고 끊기가 필요한 경우가 되게 애매하다.
    1) 접속 중 로그인(중복 로그인)
    2) 계정 정보 틀림
    * 서버 L7에서 보낸 정보를 클라 L7에서 받았는지 모르기 때문이다.
4. 클라의 종료 요청이 정상적이든 비정상적이든, 무조건 비정상적인 종료 하나로 처리하여야 한다.

## 기타 키워드
### listen MSDN 문서 살펴보기

### Backlog
1. Backlog 큐 크기 변경 방법
    1) listen 함수 backlog 인자 변경: listen(sock, SOMAXCONN_HINT(SOMAXCONN));
    2) 레지스트리 키 추가: 컴퓨터\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters > MaxUserPort 키 추가하여 값 변경
        * 레지스트리 추가 방법: https://docs.microsoft.com/ko-kr/troubleshoot/windows-client/networking/connect-tcp-greater-than-5000-error-wsaenobufs-10055

### 과제
1. 소켓 프로그래밍 Page 94~100 프로그램 짜고 테스트 하기
2. 내 컴퓨터의 Backlog 큐를 알아오기(모든 과정, 코드 기록하기), 기본 개수, 늘릴 수 있는 방법 및 개수, 실제 늘어난 개수 확인하기
