# Chapter10 동기 및 비동기 장치 I/O
## 들어가기에 앞서
### 동기와 비동기 I/O
1. 스레드가 동기적인 장치 I/O를 요청하면 I/O 작업이 완료될 때 까지 해당 스레드는 블로킹 상태가 된다. 이는 수행 성능에 나쁜 영향을 미치게 된다.
2. I/O 컴플리션 포트(aka IOCP): 매우 잘 정제된 스레드 간의 통신 매커니즘, I/O 수행 시 응답을 대기할 필요가 없다. 최초 IOCP는 장치 I/O에만 적용하게 설계되었지만, 시간이 지나면서 OS의 다양한 기능들을 하나하나 IOCP와 통합하였다.

## Section01 장치 열기와 닫기
### 장치의 특성
1. 본 책에 Page 389 표 10-1에서는 장치들의 각 특성을 표로 정리하였다.
2. 윈도우는 각 장치들 간의 차이점을 가능한 한 개발자에게 드러내지 않으려고 한다. 이렇게 함으로써 장치를 한 번 열기만 하면 장치에 대한 읽기, 쓰기를 수행하는 함수들은 장치의 종류와 상관 없이 동일하게 사용될 수 있다.

### 장치 열기 함수
1. 본 책에 Page 389 표 10-2에서는 장치들의 열기 함수들을 표로 정리하였다.
2. GetFileType
    <pre><code>
    // 입력한 핸들의 파일 타입을 반환해주는 함수                       
    // FILE_TYPE_UNKNOWN(0x0000) 반환 시 GetLastError()로 오류 코드를 확인할 수 있다.
    DWORD GetFileType(
        HANDLE hFile
    );
    </code></pre>
3. I/O의 캐시(임시 버퍼)를 없애면 해당 디바이스 드라이버

### CreateFile 함수
1. 플래그
    1) FILE_FLAG_OVERLAPPED: 해당 장치에 대하여 비동기적으로 I/O를 한다고 시스템에 알린다.

## Section03 동기 장치 I/O 수행
### 동기 I/O
1. hang 증상: 여러 원인이 있지만 그 중 동기 I/O에 의해 발생되기도 하는 현상. 시스템, 네트워크, 어플리케이션이 동작하지 않고 서비스가 응답하지 않는 상태
2. CancelSynchronousIO
    1) 기능: 지정한 스레드가 동기 I/O 작업의 완료를 대기하고 있었다면 해당 스레드는 수행을 재개하게 되고, 요청한 동기 I/O 작업은 실패하였음을 나타내는 값을 반환한다.
    <pre><code>
    BOOL WINAPI CancelSynchronousIo(
        HANDLE hThread
    );
    </code></pre>

## Section04 비동기 장치 I/O의 기본
### 비동기 I/O
1. 비동기 I/O 요청: 스레드가 비동기 I/O 요청 시 실제로 I/O 작업을 수행할 장치의 디바이스 드라이버로 전달된다. 이때 디바이스 드라이버가 장치로부터의 응답(처리)를 대기해 주기 때문에 L7의 어플리케이션은 I/O 요청 완료를 대기하지 않고 다른 작업을 계속 수행한다.
    * 디바이스 드라이버가 I/O 요청 작업에 대한 결과(송수신 완료 여부, 에러 발생 등)를 통지해 주는데 L7 단계에서 이 결과를 어떻게 처리해야할지 고민해봐야 한다.

### 비동기 장치 I/O 사용 시 주의점
1. 주의점
    1) 첫 번째: 디바이스 드라이버는 일반적으로 수행 성능을 개선시키기 위해 I/O 요청을 순서에 따라 수행하지는 않는다.
        * 파일시스템 드라이버의 경우 디스크의 헤드를 움직이는 시간 및 검색 시간을 줄이기 위해 I/O 요청 목록을 검토하여 하드 디스크의 현재 위치로부터 물리적으로 가장 가까운 위치에 대한 I/O 요청을 먼저 수행할 수 있다.
    2) 두 번째: 에러 확인을 수행하는 코드가 마련되어야 한다.
    3) 세 번째: I/O 요청에 사용된 버퍼를 I/O가 작업중인 상황에서 제거(동적 할당인 경우)하면 안되고 접근 시 동기화에 대한 고려가 이루어져야 한다. 이와 같은 이유는 드라이버가 I/O 요청 처리 시 사용자로부터 입력된 버퍼의 주소에 접근하여 직접 쓰고 읽기 때문이다.

## Section05 I/O 요청에 대한 완료 통지의 수신
### I/O 완료 통지 수신 방법
1. 윈도우는 4가지 서로 다른 방법으로 I/O 완료 통지를 받을 수 있다.
    |방법|요약|
    |---|---|
    |디바이스 커널 오브젝트의 시그널링|특정 스레드가 I/O 요청을 삽입하고 다른 스레드가 완료 통지를 수신할 수 있다. 단일 장치에 대해 다수의 I/O 요청 수행에 적합하지 않음|
    |이벤트 커널 오브젝트의 시그널링|위와 동일. 그러나 단일 장치에 대해 다수의 I/O 요청 수행 가능|
    |얼러터블(Alertable) I/O|항상 I/O 요청을 삽입한 스레드가 완료 통지를 수신한다.|
    |I/O 컴플리션 포트|특정 스레드가 I/O 요청을 삽입하고 다른 스레드가 완료 통지를 수신할 수 있다. 이 방법이 가장 확장성이 뛰어나고 유연성이 있다.|

### I/O 컴플리션 포트(이하 IOCP) 생성
1. IOCP를 구현한 이론적 배경은 동시에 수행할 수 있는 스레드 개수의 상한을 설정할 수 있어야 한다는 것이다.
2. IOCP는 클라이언트의 요청에 따라 그때마다 스레드의 생성과 소멸을 하는 것이 아닌 **스레드 풀**을 이용하도록 설계되었다.
3. IOCP 생성 함수
    <pre><code>
    // 이 함수는 서로 다른 두 가지 작업을 수행한다.
    // 기능1: I/O 컴플리션 포트 생성
    // 기능2: I/O 컴플리션 포트를 연계
    HANDLE CreateIoCompletionPort(
        HANDLE      hFile,
        HANDLE      hExistingCompletionPort,
        ULONG_PTR   CompletionKey,
        DWORD       dwNumberOfConcurrentThreads);
        
    // 사용 예시1: IOCP 생성
    CreateIoCompletionPort(INVALID_HANDLE_VALUE, NULL, 0, 스레드 개수); // dwNumberOfConcurrentThreads에 0 전달 시 CPU 개수로 동시에 수행 가능한 스레드의 최대 개수로 설정
    
    // 사용 예시2: 장치와 IOCP의 연계
    CreateIoCompletionPort(장치 핸들, 컴플리션 포트 핸들, 컴플리션 키, 0); // 컴플리션 키 값은 사용자가 임의로 결정    
    </code></pre>

### I/O 컴플리션 포트를 이용한 아키텍처 설계
1. 컴플리션 큐 대기 함수
    1) 개요: 호출한 스레드를 대기시켜 비동기 장치 I/O 완료 통지를 처리하는 기능의 함수
    2) 자세한 기능: 이 함수를 호출한 스레드의 ID 값이 대기 스레드 큐에 삽입되며, 이를 통해 IOCP 커널 오브젝트는 비동기 I/O 완료 통지를 처리할 스레드를 구분한다. IO 컴플리션 큐에 항목이 추가되면 IOCP는 대기 스레드 큐에 있는 스레드 중 하나를 깨운다. 이 스레드는 컴플리션 큐에 삽입된 항목으로부터 송수신된 바이트 수, 컴플리션 키, OVERLAPPED 구조체의 주소를 가져오게 된다.
    <pre><code> 
    BOOL GetQueuedCompletionStatus(
        HANDLE       CompletionPort,
        LPDWORD      lpNumberOfBytesTransferred,
        PULONG_PTR   lpCompletionKey,
        LPOVERLAPPED *lpOverlapped송,
        DWORD        dwMilliseconds
    );
    </code></pre>
    * 컴플리션 큐: 비동기 I/O 작업이 완료되면 완료 통지 정보가 추가되는 큐
    * 대기 스레드 큐: 완료 통지가 된 후 이에 대한 작업을 수행할 스레드의 큐
2. 일반적으로 GetQueuedCompletionStatus를 호출하여 대기 상태에 들어간 스레드를 IOCP에 "할당된"스레드라고 부른다.

### IOCP의 절차
1. IOCP의 생성 및 진행 절차
    1) IOCP 생성
    2) IOCP 장치의 연계를 통해 장치 리스트에 장치 항목을 추가
    3) IOCP에 비동기 I/O 요청
    4) 스레드 IOCP 완료 통지 처리를 위한 대기 상태 전환
    5) I/O 요청이 완료되면 시스템은 장치와 연계된 IOCP를 찾아 해당 I/O 컴플리션 큐에 I/O 요청의 완료통지를 나타내는 새로운 항목을 삽입
    6) 컴플리션 큐에 있는 완료 통지의 정보를 대기 쓰레드 큐 중 가장 마지막으로 입력된 스레드에 전달 후 스레드 재개
    7) 6에서 재개 시 IOCP는 릴리즈 스레드 리스트에 해당 스레드의 ID를 기록해두고 해당 스레드가 어떠한 함수 호출로 인해 대기 상태로 진입하면 다시 스레드의 ID를 일시 정지 스레드 리스트로 기록을 옮긴다.
