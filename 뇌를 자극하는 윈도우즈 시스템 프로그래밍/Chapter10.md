# Chapter10 컴퓨터 구조에 대한 세 번째 이야기
## Section01 절차적 함수 호출(Procedure Call) 지원 CPU 모델
### 스택 프레임 구조
1. 스택 프레임: 함수 호출 과정에서 할당되는 메모리 블록
2. 스택 프레임에는 함수의 지역변수, 전달 매개변수, 호출 종료 시 돌아갈 주소, 호출자 EBP 등의 데이터가 저장된다.
3. 스택 프레임의 크기는 해당 함수의 지역 변수 총합 크기만큼만 확보된다.

### SP 레지스터
1. SP 레지스터의 역할은 데이터를 저장할 현재 스택 공간, 즉 스택의 메모리 주소를 가리킨다.

### 프레임 포인터(Frame Pointer) 레지스터
1. 프레임 포인터(이하 FP)는 스택 프레임의 시작점, 즉 시작 주소를 가리킨다. 
    * FP가 있으므로 인하여 현재 스텍 프레임에서 SP 레지스터가 얼만큼 증가 혹은 감소하였는지 알 수 있다.
2. Windows에서 FP의 역할을 하는 레지스터는 **BP(Base Pointer)**이다.

### 스택에 저장하자, 프레임 포인터
1. 함수의 호출 Depth가 2 이상 발생하면 FP를 스택에 저장하지 않을 시 이전 함수의 FP를 덮어쓰게 된다. 따라서 함수 호출 시 지역 변수가 스택에 저장되기 전에 FP를 먼저 저장한다.

## Section02 함수 호출 인자의 전달과 PUSH & POP 명령어 디자인
### 함수 호출 인자의 전달방식
1. 성능 향상을 위해서 일부 전달 인자를 레지스터에 할당할 수 있다. 하지만, 실제 연산 코드에서 레지스터를 최대한 활용하기 위해서 전달 인자는 대부분 스택에 저장된다.

### PUSH & POP 명령어 디자인
1. PUSH: SP를 증가시키고 SP 값 주소에 데이터를 저장
2. POP: SP 값 주소에 저장된 데이터를 특정 레지스터에 저장하고 SP를 감소시킴 

## Section03 함수 호출에 의한 실행의 이동
* 생략

## Section04 함수 호출규약
### 함수 호출규약이란?
1. 함수 호출규약: **함수 호출** 시 인자 전달 방식과 스택 프레임 반환 방식 등에 대한 규칙

### __cdecl, __stdcall + alpha
1. 프로젝트 속성에서 디폴트 함수 호출규약을 지정할 수 있다.

### 호출규약의 종류와 의미
1. 스택 위 매개변수 순서
    1) 함수 호출 시 스택에 저장하는 인자의 순서를 말한다. 
    2) RTL(Right to Left): 호출 함수의 오른쪽 맨 끝 인자부터 스택에 PUSH한다.
    3) LTR(Left to Right): 호출 함수의 왼쪽 맨 끝 인자부터 스택에 PUSH한다.
2. 스택 정리 주체
    1) 호출자(Caller): 함수 호출이 끝난 뒤 호출자에서 인자를 PUSH할 때 발생한 SP가 감소한 크기만큼 SP를 증가시킨다.
    2) 피호출자(Callee): 피호출자 내부에서 return 되기 전에 인자를 PUSH한 만큼 SP를 증가시킨다.
3. 레지스터 내 매개변수: 전달되는 인자를 스택에 저장하지 않고 개수 제한적으로 레지스터에 저장한다. 이는 실행 속도를 높이기 위함이다.
* 호출규약 참고자료: https://ko.wikipedia.org/wiki/X86_%ED%98%B8%EC%B6%9C_%EA%B7%9C%EC%95%BD#x86_%ED%98%B8%EC%B6%9C_%EA%B7%9C%EC%95%BD_%EB%AA%A9%EB%A1%9D
