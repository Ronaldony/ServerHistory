# 2022/06/29 수업내용(복습 완료)
# 락프리
## 락프리 메모리풀
### 테스트
1. 메모리풀을 적용시키기 위하여 우선 메모리풀 자체에 대한 검증이 필요하다.
    * 레드 블랙 트리의 경우는 규칙(삽입, 삭제)을 모두 검사하는 형태가 되고, 길찾기는 알 방법이 없기 때문에 정상적인 동작, 성능, 크래쉬 여부 등을 검증 요소로 확인할 수 있다.
2. 메모리풀에서 오작동할 수 있는 사항
    1) Alloc: 같은 주소에 대하여 반환해주는 상황
        * 첫 번째 방법: Alloc한 주소를 모두 기록하여 순회하며 일일히 확인한다. 하지만 이건 너무 느리고 동기화가 필요하기 때문에 문제가 감춰질 수 있다. 그래서 우리의 대상은 아니다.
        * 두 번째 방법: IOCount와 같은 변수를 사용하여 Alloc할 때 증가시키고 Free할 때 감소시켜서 해당 값에 문제가 있는지 확인하여 상황을 잡아내는 방식
    2) Free: Free할 주소가 제대로 메모리풀 TOP으로 반환되지 않는 경우
        * Free를 요청하였는데 해당 노드가 정상적으로 반환되었는지에 대한 여부는 우리측에서 알기 너무 힘들다. 따라서 우리는 이 부분에 대해서 직접적으로 확인하지 않고 막연하게 개수가 틀어졌다 밖에 보지 못한다.
3. 테스트 규칙과 방법
    1) 테스트에 대한 규칙을 만들어야 한다.
        * 규칙1: 전체 할당 노드 수와 해제 수를 동일하게 맞추어 테스트를 진행한다. 이렇게 하는 이유는 막연하게 넣고 빼고 하는 형태로는 에러 발생 지점을 특정하기가 매우 힘들다. (실제 구현해보지 않았기 때문에 자세히는 상상이 안됨)
        * 규칙2: 언급한 규칙에 더하여 할당 메모리 자체에 Data와 Count를 구성 요소로 넣어 나와 같은 메모리를 사용하는 스레드가 있는가를 테스트할 수 있다. Alloc 시 Data는 특정 값, Count는 0으로 초기화하고 중간에 값을 변경 시킨 후 Free 이전에 내가 혼자 사용하고 있는가를 확인하기 위하여 Data와 Count를 확인하는 코드를 넣어 문제가 발생하는 지점을 잡아낼 수 있다.
        * 구현: 최초 노드를 10만개를 확보한다. 이후 10개의 스레드에서 1만개씩 Alloc->Free하는 동작을 반복하면서 중간 중간 Data와 Count를 확인한다.
    2) 테스트 프로그램 작성 시 락프리 메모리풀, 스택, 큐를 따로따로 구분하여 테스트 할 수 있도록 작성되어야 한다.
    3) 실패(Crash)로 판단되는 상황
        * 1: Alloc에서 NULL 값이 반환되는 경우. 각 스레드가 Alloc의 개수와 Free 개수가 같기 때문에 Alloc에서 NULL이 반환되는 경우는 절대 없어야 한다.
        * 2: Data와 Count에 대한 검사 결과에 오류가 있는 경우
        * 강사님이 언급한 문제 상황은 push와 push, pop과 pop의 문제가 아니라 push와 pop의 경합에서 일어난다고 말씀하심
    4) Push와 Pop 스레드 개수
        * Push와 Pop의 스레드 개수에 대한 논의는 코어를 고려하여 생각해보는 것이 좋다.
        * 멀티 스레드 환경에서는 다양한 방향의 수행이 이루어져야 한다.
4. 스레드들이 특정 순서대로 동작하도록 유도하는 방법
    1) 실제로 스레드를 정지시키고 다른 스레드들이 서로서로 깨워주는 방법
    2) Sleep(0)을 이용하여 퀀텀 타임을 포기하게 함으로써 해당 스레드의 순서를 조금 늦추어 스레드들의 순서를 섞을 수 있다.
5. 확인해야 할 항목
    1) 전체 할당하거나 반환된 개수, 현재 사용 개수 등..

### 디버깅
1. 락프리 메모리풀 디버깅 시 어려운 점은 명확히 문제가 되는 지점에서 크래쉬가 나거나 멈추는 행위가 되지 않기 때문이다.
2. 서버 디버깅
    1) 상황: 서버에 문제가 생겼는데 문제가 굉장히 뜸하거나 거의 읽어나지 않아 디버깅하기 힘든 상황이다. 어떠어떠한 문제에 대한 가설을 세운 상태이다.
    2) 디버깅 스레드 창에서 스레드를 중지 및 재개하면서, 조사식이나 메모리에서 직접적인 값 변경을 통해 문제 상황을 임의로 만들 수 있다.

## 기타 키워드
### 에코서버 패킷 에러 디버깅
1. 문제: Packet Error가 발생하는 문제를 어떻게 특정지어야 하나?
    1) 첫 번째 방법: WSASend 지점에서 내가 무슨 데이터를 보내는 지 확인하는 방법
    2) 두 번째 방법: 에코 서버에서 보내는 데이터가 예측가능하다라면(데이터가 1씩 증가시켜진다는 등) Send할 때 데이터를 검사하는 코드를 넣어 확인한다.
2. 위와 같은 문제 확인을 위하여 디버깅하기 위하여 라이브러리와 컨텐츠의 경계를 넘어야 한다.
3. 만약 클라이언트에서 디버깅을 위한 기능을 요구한다면 도구를 제공해야 한다.

### 기타
1. Sleep(0)고 SwitchToThread()
    1) Sleep(0)의 목적은 지금 내 퀀텀 타임을 포기하는데에 목적이 있다. 그래서 MSDN에는 프로세서에 대한 언급은 특별히 되지 않는다.
    2) SwitchToThread의 목적은 현재 프로세서의 스레드를 스위칭하는 것에 목적이 있다. 그래서 MSDN에는 다른 프로세서에서도 현재 퀀텀 타임을 포기한 스레드가 실행되지 않는다는 언급을 한다.
    3) Sleep(0) 혹은 SwitchToThread() 호출 시 해당 스레드는 Block이 아닌 Ready 큐로 가는 것이기 때문에 IOCP의 Running 상태 스레드 큐에 영향을 주지 않는다. 영향이 되는 경우는 해당 스레드가 Block 상태가 되어야 한다.
        * Sleep(1)이라면 해당 Block상태로 전환되는 것이기 때문에 Running 상태 스레드 큐에 변화를 주어 IOCP가 또 하나의 스레드를 깨우게 된다.
2. AMD 코어
    1) AMD에서는 락프리 문제가 나지 않는다. Why?
