# 2022/02/21 수업내용
# 소켓 프로그래밍
## Chapter08 소켓 옵션
### HeartBeat와 Keep alive
1. HeartBeat Timeout 시간
    1) 긴 시간: 로그인 서버 등 (보통 분 단위)
    2) 짧은 시간: 
    * Timeout 시간을 어떻게 정해야하는지 다음 시간까지 생각해오기

### SO_LINGER 옵션
1. closesocket의 역할
    1) 정상 종료 4 Handshake
    2) 연결 정보 자원 반환 요청
2. SO_LINGER에 따른 closesocket의 세 가지 동작
    1) SO_LINGER off: closesocket 함수 곧바로 리턴, 송신 버퍼 데이터 백그라운드로 모두 보내고, 4 handshake 종료
    2) SO_LINGER on + Time 0: closesocket 함수 곧바로 리턴, 송신 버퍼 데이터 삭제, 강제 종료(RST 패킷 전송)
    3) SO_LINGER on + Time 설정: Time 시간 동안 송신 버퍼 데이터 전송과 4 handshake를 시도한다. 그리고나서 closesocket을 반환한다. 만약 Timeout이 되면 송신 버퍼를 삭제하고 강제 종료한 후 함수를 반환한다.

### closesocket
1. closesocket 함수 호출 시 상황 
    1) 함수를 호출하는 순간 직전에 상대방으로부터 FIN 패킷이 올 수 있다. 이 상황에서 내 TCP는 CLOSE_WAIT 상태가 되고 이후 동작을 수행한다.
2. 4 Handshake
    1) FIN은 "더 이상 보낼게 없어:의 의미이다.
        * 따라서, 상대방측은 recv가 0을 리턴한다. 또한 상대방이 보낸 프레임을 받을 수'는' 있다.
3. TIME_WAIT
    1) 목적
        * 상황1: 패킷 도착 순서보장의 측면, 4 Handshake 전에 이전에 통신했던 패킷이 늦게 도착하는 경우를 대비하기 위하여
        * 상황2: 해당 포트를 재사용하는 경우로 해당 포트와 새로 연결된 상황이다. 세션 정보와 시퀀스 번호만 맞는다면 수신이 된다. 하지만 그럴 확률은 적다.
    2) 보통 몇초이다. 하지만 프로그래머들이 TIME_WAIT을 없애는 추세이다.
    3) 서버측에서 클라의 CLOSE_WAIT 상태가 남으면 문제가 되느냐? 해당포트로 연결 정보를 못 받느냐? => 문제도 없고 연결도 받을 수 있다. 하지만, NP풀이 증가한다.
    4) 질문: 왜 closesocket을 먼저 요청한 측에서 TIME_WAIT 상태를 남기냐?
        * 이미 연결이 끊어진 포트가 재사용되어 같은 IP, 포트의 세션 정보로 들어오는 패킷을 막아야 한다. TIME_WAIT은 이것을 막기위한 용도로도 사용된다. 한측에서만 TIME_WAIT 상태를 남겨도 이 문제를 해결할 수 있기 때문에 closesocket를 호출한 측에만 남긴다.
4. 서버가 먼저 끊는 경우: 점검, 클라이언트 비정상 접속, Heartbeat timeout 등..
    1) 서버측에서 TIME_WAIT하는 것이 가치가 있는가? => 비정상 접속이 무수히 많아지는 경우 문제가 생기기 때문에 TIME_WAIT 상태를 남기지 않아야 한다.
        * 따라서, 서버측에서 연결을 끊는 경우 무조건 RST 패킷으로 강제 종료한다.
5. L4 계층에서의 보내고 끊는 경우(RST 포함)는  L7차원에서 추가적인 

### shutdown 함수
1. TCP 입장에서는 "보내지 않겠다(FIN)"는 있는데 "받지 않겠다"는 없다.
2. shutdown은 연결 종료만 제어하는 함수이다. shutdown 함수를 사용하여 4 handshake를 L7 단계에서 제어할 수 있다.
3. Graceful shutdown
    1) 우리 입장에서는 필요 없다. 클라이언트측에서 shutdown 직전 아이템 획득이던 어떤 행동이던 서버 입장에서는
4. shutdown의 유혹
    1) 멀티스레드에서는 소켓 재사용으로 인한 동기화 문제가 생기게 된다. 이 문제를 해결하기 위해 상대방의 상태를 완벽히 파악하여 closesocket을 일괄적으로 처리한다. 이때 shutdown 유혹이 생기는데 중간에 임의로 끊어야하는 
5. Graceful shutdown의 문제점
    1) FIN_WAIT_1, FIN_WAIT_2 상태로 멈춰버리는 경우가 있다. 상대 호스트가 응답하지 않거나 OS에 문제가 생기는 경우에 발생한다.
        * 이 문제는 해결할 수가 없다. 따라서, 우리는 shutdown 함수 및 Graceful shutdown은 하지 않는다.

## 기타 키워드
### 소켓
1. closesocket 옵션 별로 모든 동작 테스트해보기
